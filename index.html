<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>"An Improviser's OS" by Wayne Krantz, visualized</title>
  <link rel="shortcut icon" href="favicon.ico">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <style>
    @font-face {
      font-family: pixeluxebinary;
      src: url("pixeluxebinary.ttf");
    }
    text {
      font-family: pixeluxebinary;
      cursor: default;
      text-anchor: middle;
      alignment-baseline: middle;
      shape-rendering: crispEdges;
    }
    text:not(#P1):hover, #scales g:hover rect {
      fill: magenta;
    }
    h1 {
      font-family: pixeluxebinary;
      position: relative;
      image-rendering: crisp-edges;
      display:inline-block;
    }
    svg {
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>2<sup>11</sup> Combinations of a Chromatic Scale</h1>
  <script>

    const widthSVG = window.innerWidth * 0.9;
    const heightSVG = window.innerHeight * 0.7;
    const svg = d3.select('body')
      .append('svg')
      .attr('width', widthSVG)
      .attr('height', heightSVG);

    const intervals = 'P1 m2 M2 m3 M3 P4 A4 P5 m6 M6 m7 M7'.split(' ');
    const getIntervalY = d3.scale.ordinal().domain(intervals)
      .rangePoints([heightSVG * 23 / 24, heightSVG / 24]);

    const marginLeft = heightSVG / 12;
    const scaleContainer = svg.append('g')
      .attr('transform', `translate(${marginLeft}, 0)`)
      .attr('clip-path', 'url(#clip)');

    const widthScales = widthSVG - marginLeft;
    const noteWidth = widthScales / 2048;
    const getNoteX = d3.scale.linear().domain([0, 2048]).range([0, widthScales]);
    const getNoteY = d3.scale.linear().domain([-1, 11]).range([heightSVG, 0]);
    const scales = [];

    const audioContext = new AudioContext();
    const gainNode = audioContext.createGain();
    gainNode.connect(audioContext.destination);
    gainNode.gain.value = 0.08;

    d3.select('h1').style('left', `${widthSVG * 0.05556}px`)
      .style('font-size', `${marginLeft / 1.6}px`)
      .style('margin-top', `${marginLeft}px`)
      .style('margin-bottom', `${marginLeft / 1.6}px`);

    svg.selectAll('text')
      .data(intervals)
      .enter()
      .append('text')
      .text(interval => interval)
      .attr('x', marginLeft / 2)
      .attr('y', interval => getIntervalY(interval))
      .attr('id', interval => interval)
      .style('font-size', `${marginLeft / 4}px`)
      .on('click', filterScales);

    svg.append('defs')
      .append('clipPath')
      .attr('id', 'clip')
      .append('rect')
      .attr('width', widthScales)
      .attr('height', heightSVG);

    (function populate(scale, mask, length, indices) {
      if (mask == 0) return scales[indices[length]++] = scale;
      populate(scale | mask, mask >> 1, length + 1, indices);
      populate(scale, mask >> 1, length, indices);
    })(2048, 1024, 1, {'1':0, '2':1, '3':12, '4':67, '5':232, '6':562,
      '7':1024, '8':1486, '9':1816, '10':1981, '11':2036, '12':2047});

    plotScales(scales);

    function plotScales(scales) {
      scaleContainer.append('g')
        .attr('id', 'scales')
        .call(d3.behavior.zoom()
          .scaleExtent([1, 25])
          .on('zoom', zoom))
        .selectAll('g')
        .data(scales)
        .enter()
        .append('g')
        .on('mouseover', toggleMissingIntervals)
        .on('mouseout', toggleMissingIntervals)
        .on('click', playScale)
        .selectAll('rect')
        .data(scale => (scale).toString(2))
        .enter()
        .append('rect')
        .attr('x', (note, i, j) => getNoteX(j))
        .attr('y', (note, i) => getNoteY(i))
        .attr('width', noteWidth)
        .attr('height', marginLeft)
        .attr('fill', note => note == '0' ? 'white' : 'black');
    }

    function filterScales() {
      const interval = d3.select(this);
      if (interval.data() != 'P1') {
        interval.classed('include', !interval.classed('include'));
        const include = d3.selectAll('.include')
          .data()
          .map(interval => 1 << 11 - intervals.indexOf(interval))
          .reduce((last, current) =>  last + current, 0);
        d3.select('#scales').remove();
        plotScales(scales.filter(scale => (scale & include) == include));
      }
    }

    function zoom() {
      const s = d3.event.scale;
      const x = Math.min(0, Math.max(widthScales * (1 - s), d3.event.translate[0]));
      d3.select(this).attr('transform', `translate(${x}, 0) scale(${s}, 1)`);
    }

    function toggleMissingIntervals() {
      const scale = d3.select(this).selectAll('rect').data();
      const missingIntervalSelector = intervals
        .filter((interval, i) => scale[i] == '0')
        .map(interval => `#${interval}`).join();
      const missingIntervals = d3.selectAll(missingIntervalSelector);
      const areWhite = missingIntervals.attr('fill') == 'white';
      missingIntervals.attr('fill', areWhite ? 'black' : 'white');
    }

    function playNote(delay, interval, duration) {
      const oscillator = audioContext.createOscillator();
      oscillator.connect(gainNode);
      oscillator.type = 'square';
      oscillator.frequency.value = 110;
      oscillator.detune.value = 100 * interval;
      const startTime = audioContext.currentTime + delay;
      oscillator.start(startTime);
      oscillator.stop(startTime + duration);
    }

    function playScale() {
      const scale = d3.select(this).selectAll('rect').data();
      const scaleIntervals = intervals.filter((interval, i) => scale[i] == '1')
        .map(interval => intervals.indexOf(interval));
      let delay = 0;
      let currentIndex = scaleIntervals.length;
      let randomIndex;
      let temp;
      let duration;
      while (currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        duration = Math.random() < 2 / 3 ? 0.18 : 0.36;
        playNote(delay, scaleIntervals[randomIndex], duration);
        delay += duration;
        currentIndex--;
        temp = scaleIntervals[currentIndex];
        scaleIntervals[currentIndex] = scaleIntervals[randomIndex];
        scaleIntervals[randomIndex] = temp;
      }
    }
  </script>
</body>
</html>
