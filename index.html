<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>"An Improviser's OS" by Wayne Krantz, visualized</title>
  <link rel="shortcut icon" href="favicon.ico">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <style>
    @font-face {
      font-family: pixeluxebinary;
      src: url("pixeluxebinary.ttf");
    }
    text {
      font-family: pixeluxebinary;
      cursor: default;
      text-anchor: middle;
      alignment-baseline: middle;
      shape-rendering: crispEdges;
    }
    h1 {
      font-family: pixeluxebinary;
      position: relative;
      image-rendering: crisp-edges;
      display:inline-block;
    }
    svg {
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>2<sup>11</sup> Combinations of a Chromatic Scale</h1>
  <script>

    const windowWidth = window.innerWidth;
    const spread = 0.9;
    const totalWidth = windowWidth * spread;
    const height = window.innerHeight * 0.7;
    const marginLeft = height / 12;
    const width = totalWidth - marginLeft;
    const color = (bit) => (bit == '0') ? 'white' : 'black';
    const svg = d3.select('body')
      .append('svg')
      .attr('width', totalWidth)
      .attr('height', height);
    const header = 'P1,m2,M2,m3,M3,P4,A4,P5,m6,M6,m7,M7'.split(',');
    const x = d3.scale.linear().domain([0, 2048]).range([0, width]);
    const rectWidth = width / 2048;
    const rectHeight = marginLeft;
    const yRect = d3.scale.linear().domain([-1, 11]).range([height, 0]);
    const yLab = d3.scale.ordinal().domain(header)
      .rangePoints([height * 23 / 24, height / 24]);
    const data = [];
    const audioContext = new AudioContext();

    d3.select('h1').style('left', windowWidth * (1 - spread) / 2 + 'px')
      .style('font-size', rectHeight / 1.6 + 'px')
      .style('margin-top', rectHeight + 'px')
      .style('margin-bottom', rectHeight / 1.6 + 'px');

    svg.selectAll('text')
      .data(header)
      .enter()
      .append('text')
      .text(d => d)
      .attr('x', marginLeft / 2)
      .attr('y', d => yLab(d))
      .attr('id', d => d)
      .style('font-size', rectHeight / 4 + 'px')
      .on('mouseover', function () {
        const label = d3.select(this);
        if (label.data() != 'P1') label.attr('fill', 'magenta');
      })
      .on('mouseout', function () {d3.select(this).attr('fill', 'black');})
      .on('click', function () {
        const label = d3.select(this);
        if (label.data() != 'P1') {
          label.attr('class', (label.attr('class') != 'on') ? 'on' : 'off');
          const include = d3.selectAll('.on')
            .data()
            .map(d => 1 << 11 - header.indexOf(d))
            .reduce((d1, d2) => d1 + d2, 0);
          d3.select('.rectangles').remove();
          plotRectangles(data.filter(d => (d & include) == include));
        }
      });

    svg.append('defs')
      .append('clipPath')
      .attr('id', 'clip')
      .append('rect')
      .attr('width', width)
      .attr('height', height);

    (function createData (scale, mask, length, indices) {
      if (mask == 0) return (data[indices[length]++] = scale);
      createData(scale | mask, mask >> 1, length + 1, indices);
      createData(scale & ~mask, mask >> 1, length, indices);
    })(2048, 1024, 1, {'1':0, '2':1, '3':12, '4':67, '5':232, '6':562,
      '7':1024, '8':1486, '9':1816, '10':1981, '11':2036, '12':2047});

    const rectContainer = svg.append('g')
      .attr('transform', 'translate(' + marginLeft  + ', 0)')
      .attr('clip-path', 'url(#clip)');

    function plotRectangles(data) {
      const rectangles = rectContainer.append('g').attr('class', 'rectangles');
      rectangles.selectAll('g')
        .data(data)
        .enter()
        .append('g')
        .selectAll('rect')
        .data(d => (d).toString(2))
        .enter()
        .append('rect')
        .attr('x', (d, i, j) => x(j))
        .attr('y', (d, i) => yRect(i))
        .attr('width', rectWidth)
        .attr('height', rectHeight)
        .attr('fill', d => color(d));
      const zoom = d3.behavior.zoom()
        .scaleExtent([1, 25])
        .on('zoom', function () {
          const s = d3.event.scale;
          const x = Math.min(0, Math.max(width * (1 - s), d3.event.translate[0]));
          rectangles.attr('transform', 'translate(' + x + ', 0) scale(' + s + ', 1)');
        });
      rectangles.call(zoom);
      rectangles.selectAll('g')
        .on('mouseover', function () {
          const rectangles = d3.select(this).selectAll('rect');
          rectangles.attr('fill', 'magenta');
          d3.selectAll(getZeroSelector(rectangles.data())).attr('fill', 'white');
        })
        .on('mouseout', function () {
          const rectangles = d3.select(this).selectAll('rect');
          rectangles.attr('fill', d => color(d));
          d3.selectAll(getZeroSelector(rectangles.data())).attr('fill', 'black');
        })
        .on('click', function () {
          playScale(d3.select(this).selectAll('rect').data());
        });
    }

    plotRectangles(data);

    function getZeroSelector(scale) {
      return '#' + header.filter((d, i) => scale[i] == '0').join(', #');
    }

    function playNote(delay, interval, duration) {
      const gainNode = audioContext.createGain();
      gainNode.connect(audioContext.destination);
      gainNode.gain.value = 0.08;
      const oscillator = audioContext.createOscillator();
      oscillator.connect(gainNode);
      oscillator.type = 'square';
      oscillator.frequency.value = 110;
      oscillator.detune.value = 100 * interval;
      const startTime = audioContext.currentTime + delay;
      oscillator.start(startTime);
      oscillator.stop(startTime + duration);
    }

    function playScale(scale) {
      const shuffled = [0];
      for (let i = 1; i < 12; i++) {
        if (scale[i] == '1') {
          shuffled.push(i);
        }
      }
      let delay = 0;
      let currentIndex = shuffled.length;
      let randomIndex;
      let temp;
      let duration;
      while (currentIndex > 0) {
        randomIndex = Math.random() * currentIndex | 0;
        duration = (Math.random() < 2 / 3) ? 0.18 : 0.36;
        playNote(delay, shuffled[randomIndex], duration);
        delay += duration;
        currentIndex--;
        temp = shuffled[currentIndex];
        shuffled[currentIndex] = shuffled[randomIndex];
        shuffled[randomIndex] = temp;
      }
    }
  </script>
</body>
</html>
